<div class="p-4 lg:p-6 space-y-6 animate-in fade-in duration-500">
    <!-- Header Section -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 px-1">
        <div>
            <h2 class="text-lg font-black text-slate-900 tracking-tight uppercase flex items-center gap-2.5">
                <span class="w-1 h-6 bg-gradient-to-b from-orange-500 to-amber-500 rounded-full"></span>
                Receivables Ledger
            </h2>
            <div class="flex items-center gap-2 mt-0.5">
                <span class="text-slate-400 text-[9px] font-bold uppercase tracking-wider">SYSTEM NODE:
                    DEBT_REPOSITORY</span>
                <span class="w-1 h-1 rounded-full bg-slate-300"></span>
                <span class="text-orange-600 text-[9px] font-bold uppercase tracking-wider">ACTIVE COLLECTIONS</span>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <div class="relative group w-full md:w-72">
                <i
                    class="fas fa-search absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400 text-[10px] group-focus-within:text-orange-500 transition-colors"></i>
                <input type="text" id="debtSearchInput" placeholder="Search client name or plate..."
                    class="w-full pl-9 pr-4 py-2 bg-white border border-slate-200 rounded-xl text-[11px] font-bold text-slate-700 placeholder:text-slate-400 focus:border-orange-500 focus:ring-4 focus:ring-orange-500/5 transition-all outline-none shadow-sm">
            </div>
            <button
                class="px-4 py-2 bg-white border border-slate-200 text-slate-600 text-[9px] font-black uppercase tracking-widest rounded-xl hover:bg-slate-50 transition-all flex items-center gap-2 shadow-sm">
                <i class="fas fa-download text-[8px]"></i> <span>Export</span>
            </button>
        </div>
    </div>

    <!-- Stats Bar -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4">
        <div class="bg-white p-3 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-3">
            <div class="w-9 h-9 rounded-xl bg-orange-50 text-orange-500 flex items-center justify-center text-sm"><i
                    class="fas fa-hand-holding-dollar"></i></div>
            <div>
                <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest leading-tight">Total Pending
                </p>
                <p class="text-xs font-black text-slate-900 leading-none" id="stat-pending-amount">--</p>
            </div>
        </div>
        <div class="bg-white p-3 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-3">
            <div class="w-9 h-9 rounded-xl bg-rose-50 text-rose-500 flex items-center justify-center text-sm"><i
                    class="fas fa-clock"></i></div>
            <div>
                <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest leading-tight">Overdue</p>
                <p class="text-xs font-black text-slate-900 leading-none" id="stat-overdue-count">--</p>
            </div>
        </div>
        <div class="bg-white p-3 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-3">
            <div class="w-9 h-9 rounded-xl bg-emerald-50 text-emerald-500 flex items-center justify-center text-sm"><i
                    class="fas fa-calendar-check"></i></div>
            <div>
                <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest leading-tight">Repayment Rate
                </p>
                <p class="text-xs font-black text-slate-900 leading-none" id="stat-repayment-rate">74.2%</p>
            </div>
        </div>
        <div class="bg-white p-3 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-3">
            <div class="w-9 h-9 rounded-xl bg-indigo-50 text-indigo-500 flex items-center justify-center text-sm"><i
                    class="fas fa-users-viewfinder"></i></div>
            <div>
                <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest leading-tight">Active Debtors
                </p>
                <p class="text-xs font-black text-slate-900 leading-none" id="stat-debtor-count">--</p>
            </div>
        </div>
    </div>

    <!-- Debts Table Section -->
    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden min-h-[400px]">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-white border-b border-slate-100">
                        <th class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest w-32">Asset
                            Reference</th>
                        <th class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest">Client
                            Identity / Contact</th>
                        <th class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest w-32">
                            Balance Due</th>
                        <th class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest w-40">Status
                            / Timeline</th>
                        <th
                            class="px-5 py-3 text-[9px] font-black text-slate-400 uppercase tracking-widest text-right w-24">
                            Actions</th>
                    </tr>
                </thead>
                <tbody id="debtsTableBody" class="divide-y divide-slate-50">
                    <!-- Data loaded via JS -->
                </tbody>
            </table>

            <!-- Skeleton Loading State -->
            <div id="loadingIndicator" class="hidden py-6">
                <div class="px-5 space-y-4">
                    <div class="flex items-center gap-4 animate-pulse">
                        <div class="h-4 bg-slate-50 rounded w-28"></div>
                        <div class="h-4 bg-slate-50 rounded flex-1"></div>
                        <div class="h-4 bg-slate-50 rounded w-24"></div>
                        <div class="h-4 bg-slate-50 rounded w-32"></div>
                    </div>
                    <div class="flex items-center gap-4 animate-pulse opacity-60">
                        <div class="h-4 bg-slate-50 rounded w-28"></div>
                        <div class="h-4 bg-slate-50 rounded flex-1"></div>
                        <div class="h-4 bg-slate-50 rounded w-24"></div>
                        <div class="h-4 bg-slate-50 rounded w-32"></div>
                    </div>
                </div>
            </div>

            <div id="noDataMessage" class="hidden py-16 text-center">
                <div
                    class="w-14 h-14 bg-slate-50 rounded-2xl flex items-center justify-center mx-auto mb-4 border border-slate-100">
                    <i class="fas fa-hand-holding-heart text-lg text-slate-300"></i>
                </div>
                <h3 class="text-[11px] font-black text-slate-900 uppercase">Clear Receivables</h3>
                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-1">All debts have been
                    successfully settled</p>
            </div>

            <div id="loadMoreTrigger" class="h-4"></div>
        </div>
    </div>
</div>

<script>
    let page = 1;
    let loading = false;
    let hasMore = true;
    let searchTerm = "";

    const tableBody = document.getElementById('debtsTableBody');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const loadMoreTrigger = document.getElementById('loadMoreTrigger');
    const noDataMessage = document.getElementById('noDataMessage');
    const searchInput = document.getElementById('debtSearchInput');

    async function fetchDebts(reset = false) {
        if (loading || (!hasMore && !reset)) return;
        if (reset) {
            page = 1;
            hasMore = true;
            tableBody.innerHTML = '';
            noDataMessage.classList.add('hidden');
        }

        loading = true;
        if (page === 1) loadingIndicator.classList.remove('hidden');

        try {
            const response = await fetch(`/api/debts?page=${page}&search=${encodeURIComponent(searchTerm)}`);
            if (!response.ok) throw new Error('Ledger Access Failed');
            const data = await response.json();

            // Stats Update
            if (page === 1 && data.total !== undefined) {
                document.getElementById('stat-debtor-count').textContent = data.total;
                const totalPending = data.debts ? data.debts.reduce((sum, d) => sum + d.remaining_balance, 0) : 0;
                document.getElementById('stat-pending-amount').textContent = `Ush ${totalPending.toLocaleString()}`;
                const overdueCount = data.debts ? data.debts.filter(d => new Date(d.payment_deadline) < new Date()).length : 0;
                document.getElementById('stat-overdue-count').textContent = overdueCount;
            }

            if (data.debts && data.debts.length > 0) {
                data.debts.forEach(debt => {
                    const row = document.createElement('tr');
                    row.className = "group hover:bg-slate-50/80 transition-all duration-200 border-b border-slate-50 last:border-0";

                    const deadline = new Date(debt.payment_deadline);
                    const now = new Date();
                    const diffDays = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
                    const statusClass = diffDays < 0 ? "bg-rose-50 text-rose-600 border-rose-100" : diffDays <= 7 ? "bg-amber-50 text-amber-600 border-amber-100" : "bg-emerald-50 text-emerald-600 border-emerald-100";
                    const statusText = diffDays < 0 ? `${Math.abs(diffDays)}d overdue` : `${diffDays}d left`;

                    row.innerHTML = `
                        <td class="px-5 py-3">
                            <span class="text-[10px] font-black text-slate-900 tracking-tight uppercase">${debt.car_number_plate || 'N/A'}</span>
                        </td>
                        <td class="px-5 py-3">
                            <div class="flex flex-col">
                                <span class="text-[10px] font-black text-slate-700 uppercase tracking-wide truncate w-64">${debt.client_name || 'N/A'}</span>
                                <a href="tel:${debt.client_phone}" class="text-[8px] font-bold text-indigo-500 hover:underline transition-colors">${debt.client_phone || 'N/A'}</a>
                            </div>
                        </td>
                        <td class="px-5 py-3">
                            <span class="text-[10px] font-black text-rose-600 tracking-tight">Ush ${debt.remaining_balance.toLocaleString()}</span>
                        </td>
                        <td class="px-5 py-3">
                            <div class="flex items-center gap-2">
                                <span class="px-2 py-0.5 rounded text-[8px] font-black uppercase tracking-tight border ${statusClass}">${statusText}</span>
                                <span class="text-[8px] font-black text-slate-300 uppercase tracking-widest">${deadline.toLocaleDateString()}</span>
                            </div>
                        </td>
                        <td class="px-5 py-3 text-right">
                            <div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-all duration-300">
                                <a href="/cars/edit/${debt.car_id}" class="w-7 h-7 flex items-center justify-center bg-white border border-slate-200 text-slate-400 hover:text-indigo-600 hover:border-indigo-500 rounded-lg transition-all shadow-sm">
                                    <i class="fas fa-eye text-[9px]"></i>
                                </a>
                                <button class="w-7 h-7 flex items-center justify-center bg-white border border-slate-200 text-slate-400 hover:text-rose-600 hover:border-rose-500 rounded-lg transition-all shadow-sm" title="Delete Debt Instance">
                                    <i class="fas fa-trash text-[9px]"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                page++;
                hasMore = data.has_more;
            } else if (page === 1) {
                noDataMessage.classList.remove('hidden');
                hasMore = false;
            } else {
                hasMore = false;
            }
        } catch (error) {
            console.error('Ledger Sync Critical Failure:', error);
        } finally {
            loading = false;
            loadingIndicator.classList.add('hidden');
        }
    }

    // Search & Scroll logic
    let debounce;
    searchInput.addEventListener('input', (e) => {
        searchTerm = e.target.value;
        clearTimeout(debounce);
        debounce = setTimeout(() => fetchDebts(true), 400);
    });

    const observer = new IntersectionObserver((entries) => {
        if (entries[0].isIntersecting && hasMore && !loading) fetchDebts();
    }, { threshold: 0.1 });
    observer.observe(loadMoreTrigger);

    fetchDebts();
</script>